<!DOCTYPE html>

<head>
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <title>JCHS POS - Main</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
        }

        .menuSlot {
            width: 50px;
            height: 50px;
            padding: 10px;
        }

        .active {
            cursor: pointer;
        }

        .active:active {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .now {
            width: 50px;
            filter: invert(100%) drop-shadow(0px 0px 5px rgba(0, 0, 0, 0.363));
        }

        .category {
            font-size: 20px;
            font-family: Arial, Helvetica, sans-serif;
            overflow: hidden;
            margin: 10px;
            height: 123px;
        }

        .item {
            font-size: 20px;
            height: 80px;
            width: 150px;
            border-radius: 10px;
            background: linear-gradient(to right bottom, rgb(240, 240, 240), rgb(221, 221, 221));
            margin: 10px;
            text-align: center;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        .item:active {
            background: linear-gradient(to right bottom, rgb(226, 226, 226), rgb(197, 197, 197));
        }

        .detail {
            position: absolute;
            top: 18px;
            font-family: Georgia, 'Times New Roman', Times, serif;
        }

        .center {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 50%;
        }

        .orderBorder {
            border: 1px solid #dadada;
            font-size: 20px;
            padding: 0px 5px 0px 5px;
        }

        .orderButton {
            user-select: none;
            width: 100%;
            height: 30px;
            font-size: 26px;
            position: relative;
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: rgb(230, 230, 230);
            color: rgb(50, 50, 50);
            text-align: center;
        }

        .orderButton:active {
            background-color: rgb(210, 210, 210);
        }

        .stActive {
            border-radius: 20px;
            height: 20px;
            width: 20px;
            background-color: lightgreen;
            transform: translate(-50%, -50%);
        }

        .stUnactive {
            border-radius: 20px;
            height: 20px;
            width: 20px;
            background-color: red;
            transform: translate(-50%, -50%);
        }

        /* width */
        ::-webkit-scrollbar {
            width: 10px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #888;
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body>

    <div id="main"
        style="position: absolute; width: 90%; height: 85%; top: 50%; left: 50%; transform: translate(-46%, -48%); overflow: auto;">
        <div id="categoryList">
        </div>

    </div>

    <div id="menu"
        style="width: 70px; height: 100vh; background-image: linear-gradient(rgb(240, 240, 240), lightgray); top: 50%; left: 1.9%; position: absolute; transform: translate(0%, -50%);">
        <div style="top: 50%; position: relative; transform: translate(0%, -50%);">
            <div class="menuSlot active">
                <div style="height: 6px;"></div>
                <div style="height: 8px; background-color: rgb(54, 54, 54); width: 50px;"></div>
                <div style="height: 10px;"></div>
                <div style="height: 8px; background-color: rgb(54, 54, 54); width: 50px;"></div>
                <div style="height: 10px;"></div>
                <div style="height: 8px; background-color: rgb(54, 54, 54); width: 50px;"></div>
                <div style="height: 6px;"></div>
            </div>
            <div class="menuSlot now">
                <img src="png/home.png" style="width: 50px;" />
            </div>
            <div class="menuSlot active" onclick="window.location.href = 'attendance.html';">
                <img src="png/attendance.png" style="width: 50px;" />
            </div>
            <div class="menuSlot active" onclick="window.location.href = 'cash_record.html';">
                <img src="png/money_bag.png" style="width: 50px;" />
            </div>
            <div class="menuSlot">

            </div>
            <div class="menuSlot">

            </div>
            <div class="menuSlot">

            </div>
            <div class="menuSlot">

            </div>
            <div class="menuSlot active" onclick="logout()">
                <img src="png/logout.png" style="width: 50px;" />
            </div>
        </div>
    </div>

    <div id="detail">
        <div id="Title" class="detail" style="font-size: 50px; left: 10.5%;">HOME</div>
        <div class="detail" style="position: absolute; z-index: 3; right: 30px; white-space: nowrap;">
            <div id="accStatus" style="position: absolute;"></div>
            <div id="Account" style="z-index: 3; font-size: 20px; position: relative;">[Account]</div>
        </div>
    </div>

    <div id="order"></div>

    <div id="resizeOrder"
        style="position: absolute; top: 50%; transform: translate(0%, -50%); right: 0px; height: 50px; width: 25px; border-radius: 50px 0px 0px 50px; background-color: rgb(255, 255, 255, 0.9); filter: drop-shadow(6px 0px 15px rgb(0, 0, 0, 0.6));"
        onclick="order();">
    </div>

</body>
<script>

    //database
    var category = [
        [
            "Hair",
            [
                ["Cut", 5],
                ["Color", 7],
                ["Style 1", 8],
                ["Style 2", 10],
                ["Style 3", 11],
                ["Style 4", 8],
                ["Style 5", 9],
                ["Style 6", 1000]
            ]
        ],
        [
            "Wash",
            [
                ["Warm", 8],
                ["Cold", 7]
            ]
        ],
        [
            "Blow Hair",
            [
                ["Normal", 8],
                ["Advanced", 10]
            ]
        ],
        [
            "Test1",
            [
                ["Test", 1]
            ]
        ],
        [
            "Test2",
            [
                ["Test", 1]
            ]
        ], [
            "Test3",
            [
                ["Test", 1]
            ]
        ]
    ];

    //Start up
    window.onload = function () {
        //Get data from session storage
        var user = sessionStorage.getItem("user");
        if (user) {
            document.getElementById("Account").innerHTML = user;
        } else {

            //session outdated
            var info = "Session outdated.\n Please login again.";
            document.body.innerHTML += `
                <div style="position: absolute; left: 0px; top: 0px; height: 100%; width: 100%; z-index: 1;">
                    <div style="font-size: 30px; white-space: pre-line; text-align: center; position: absolute; top: 50%; left: 50%; padding: 10px 30px 10px 30px; transform: translate(-50%, -50%); border: 1px solid rgba(0, 0, 0, 0.6); background-color: rgba(255, 255, 255, 0.6);"
                    >${info}
                        <button type="button" onclick="window.location.href = 'staffcode.html'">Return to Login</button>
                    </div>
                </div>
            `;

        }

        //Direct to login if login is outdated. (not staff code)
        if (!localStorage.getItem("account")) {
            window.location.href = "login.html";
        }

        if (sessionStorage.getItem("balance") == null) {
            sessionStorage.setItem("balance", JSON.stringify(0));
        }

        //initialise category list and item list
        //Left and Right arrow
        for (var i = 0; i < category.length; i++) {
            document.getElementById("categoryList").innerHTML += `
                <div class="category">
                    <div id="right_${category[i][0]}" style="display: none; position: absolute; right: 30px; padding: 20px 2px 20px 2px; top: 8%;" onclick="document.getElementById('itemList_' + '${category[i][0]}').scrollBy(170, 0);">
                        <div style="border-style: solid solid none none; height: 15px; width: 15px; border-width: 2px; transform: rotate(45deg);">
                        </div>
                    </div>
                    <div id="left_${category[i][0]}" style="display: none; position: absolute; left: 30px; padding: 20px 2px 20px 2px; top: 8%;" onclick="document.getElementById('itemList_' + '${category[i][0]}').scrollBy(-170, 0);">
                        <div style="border-style: solid solid none none; height: 15px; width: 15px; border-width: 2px; transform: rotate(225deg);">
                        </div>
                    </div>
                    <div style="position: relative; left: 10px;">${category[i][0]}</div>
                    <div id="itemList_${category[i][0]}" onscroll="advScr('${category[i][0]}');" style="font-size: 0px; white-space: nowrap; overflow: auto;">
                    </div>
                </div>
            `;
        }

        //Set item list in category
        updateItemList();
    }

    //Scroll function
    function advScr(elemId) {
        var tar = document.getElementById("itemList_" + elemId);
        tar.scrollLeft == 0 ? document.getElementById("left_" + elemId).style.display = "none" : document.getElementById("left_" + elemId).style.display = "block";
        tar.scrollLeft + tar.clientWidth == tar.scrollWidth ? document.getElementById("right_" + elemId).style.display = "none" : document.getElementById("right_" + elemId).style.display = "block";

        //console.log("Hi " + "itemList_" + elemId + " " + document.getElementById("itemList_" + elemId).scrollLeft);
    }

    function updateItemList() {
        //console.log(itemMax);
        for (var i = 0; i < category.length; i++) {
            document.getElementById("itemList_" + category[i][0]).innerHTML = '';

            for (var j = 0; j < category[i][1].length; j++) {
                document.getElementById("itemList_" + category[i][0]).innerHTML += `
                    <div class="item" onclick="order(${i}, ${j});">
                        ${category[i][1][j][0]}
                        <br>
                        RM ${category[i][1][j][1]}
                    </div>
                `;
            }

            //Detect if elements' total width is out of size
            if (category[i][1].length * 170 > document.getElementById("itemList_" + category[i][0]).clientWidth) {
                document.getElementById("right_" + category[i][0]).style.display = "block";
                //console.log(category[i][1].length + " > " + document.getElementById("itemList_" + category[i][0]).clientWidth);
            }
        }
    }

    //Retrieve item from array using index
    function order(i, j) {

        console.log(name + " " + price);
        document.getElementById("order").innerHTML += `
            <div style="position: absolute; left: 0px; top: 0px; height: 100%; width: 100%; z-index: 1; background-color: rgb(0, 0, 0, 0.3);" onclick="document.getElementById('order').innerHTML = '';"></div>
            
            <div style="z-index: 2; position: absolute; right: 0px; filter: drop-shadow(0px 0px 25px rgb(0, 0, 0, 0.3));">
                <div id="resizeOrder" style="position: absolute; right: 500px; top: 50vh; transform: translate(0%, -50%); height: 50px; width: 25px; border-radius: 50px 0px 0px 50px; background-color: rgb(255, 255, 255, 0.9);"></div>
                <div id="orderContainer" style="position: absolute; right: 0px; height: 90vh; padding: 5vh 25px 5vh 25px; width: 450px; background-color: rgb(255, 255, 255, 0.95); overflow: auto;">

                    <div style="position: relative; top: 5%;">
                        <div id="newItemSpace"></div>
                        <div style="font-size: 30px; position: relative;">
                            Order
                        </div>
                        <table id="orderList" style="border-collapse: collapse; width: 100%; position: relative; margin-top: 10px;">
                            <tr class="orderBorder">
                                <td class="orderBorder" style="width: 28px;"></td>
                                <td class="orderBorder">Name</td>
                                <td class="orderBorder" style="width: 100px;">Category</td>
                                <td class="orderBorder" style="width: 100px;">Price(RM)</td>
                            <tr>
                        </table>
                        <div id="submitOrder" style="user-select: none; width: 100%; height: 30px; font-size: 26px; position: relative; margin-top: 20px; text-align: center;">
                            Submit
                        </div>
                    </div>

                </div>
            </div>

        `;

        //If order is empty
        if (JSON.parse(sessionStorage.getItem("order")).length != 0 && JSON.parse(sessionStorage.getItem("order")).length != null) {
            document.getElementById("submitOrder").outerHTML = `
                <div id="submitOrder" class="orderButton" onclick="submitOrder();">
                    Submit
                </div>
            `;
        }

        if (i != null && j != null) {
            var categoryName = category[i][0];
            var name = category[i][1][j][0];
            var price = category[i][1][j][1].toFixed(2);

            document.getElementById("newItemSpace").outerHTML += `
                <div id="newItemSpace" style="margin-bottom: 50px;">
                    <div style="font-size: 30px; position: relative;">
                        New Item
                    </div>
                    <table id="newItem" style="border-collapse: collapse; width: 100%; position: relative; margin-top: 10px;">
                        <tr class="orderBorder">
                            <td class="orderBorder" style="width: 28px;"></td>
                            <td class="orderBorder">Name</td>
                            <td class="orderBorder" style="width: 100px;">Category</td>
                            <td class="orderBorder" style="width: 100px;">Price(RM)</td>
                        <tr>
                    </table>
                    <div id="addOrder" class="orderButton" onclick="addOrder('${name}', '${categoryName}', ${price});">
                        Add to order
                    </div>
                </div>
            `;

            document.getElementById('newItem').innerHTML += `
                <tr class="orderBorder">
                    <td class="orderBorder">1.</td>
                    <td class="orderBorder">${name}</td>
                    <td class="orderBorder">${categoryName}</td>
                    <td class="orderBorder" style="text-align: right;">${price}</td>
                </tr>
            `;
        }

        var order = JSON.parse(sessionStorage.getItem("order"));
        var totalPrice = 0;

        for (var i = 0; i < order.length; i++) {
            var name = order[i][0];
            var categoryName = order[i][1];
            var price = order[i][2].toFixed(2);
            totalPrice += order[i][2];

            document.getElementById('orderList').innerHTML += `
                <tr class="orderBorder">
                    <td class="orderBorder">${i + 1}.</td>
                    <td class="orderBorder">${name}</td>
                    <td class="orderBorder">${categoryName}</td>
                    <td class="orderBorder" style="text-align: right;">${price}</td>
                </tr>
            `;
        }

        document.getElementById('orderList').innerHTML += `
            <tr class="orderBorder">
                <td class="orderBorder" colspan="3" style="text-align: right;">Total</td>
                <td class="orderBorder" style="text-align: right;">${totalPrice.toFixed(2)}</td>
            </tr>
        `;

    }

    //add item to order
    function addOrder(name, categoryName, price) {

        //enable submit
        document.getElementById("submitOrder").outerHTML = `
            <div id="submitOrder" class="orderButton" onclick="submitOrder();">
                Submit
            </div>
        `;

        //get array from storage
        var order = JSON.parse(sessionStorage.getItem("order"));
        order.push([name, categoryName, price]);
        sessionStorage.setItem("order", JSON.stringify(order));
        document.getElementById("addOrder").outerHTML = `
            <div id="addOrder" style="width: 100%; height: 30px; font-size: 26px; position: relative; margin-top: 20px; text-align: center;">
                Added <span style="color: green;">✓</span>
            </div>
        `;

        document.getElementById('orderList').innerHTML = `
            <table id="orderList" style="border-collapse: collapse; width: 100%; position: relative; margin-top: 10px;">
                <tr class="orderBorder">
                    <td class="orderBorder" style="width: 28px;"></td>
                    <td class="orderBorder">Name</td>
                    <td class="orderBorder" style="width: 100px;">Category</td>
                    <td class="orderBorder" style="width: 100px;">Price(RM)</td>
                <tr>
            </table>
        `;

        //Display order list
        var order = JSON.parse(sessionStorage.getItem("order"));
        var totalPrice = 0;

        for (var i = 0; i < order.length; i++) {
            var name = order[i][0];
            var categoryName = order[i][1];
            var price = order[i][2].toFixed(2);
            totalPrice += order[i][2];

            if (i == order.length - 1) {
                document.getElementById('orderList').innerHTML += `
                    <tr class="orderBorder" style="background-color: rgb(204, 255, 255);">
                        <td class="orderBorder">${i + 1}.</td>
                        <td class="orderBorder">${name}</td>
                        <td class="orderBorder">${categoryName}</td>
                        <td class="orderBorder" style="text-align: right;">${price}</td>
                    </tr>
                `;
            } else {
                document.getElementById('orderList').innerHTML += `
                    <tr class="orderBorder">
                        <td class="orderBorder">${i + 1}.</td>
                        <td class="orderBorder">${name}</td>
                        <td class="orderBorder">${categoryName}</td>
                        <td class="orderBorder" style="text-align: right;">${price}</td>
                    </tr>
                `;
            }
        }

        //Refresh total price
        document.getElementById('orderList').innerHTML += `
            <tr class="orderBorder">
                <td class="orderBorder" colspan="3" style="text-align: right;">Total</td>
                <td class="orderBorder" style="text-align: right;">${totalPrice.toFixed(2)}</td>
            </tr>
        `;
    }

    function submitOrder() {

    }

    function logout() {
        //Clear session storage *temp
        var user = sessionStorage.getItem("user");
        if (user) {
            sessionStorage.removeItem("user");
            sessionStorage.setItem("order", JSON.stringify([]));
            window.location.href = "staffcode.html";
        }
    }

</script>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";

    //createUserWithEmailAndPassword
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, set, ref, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDJ2tr5BgD5euyA_Mdez-GyD0z6JFFb0lY",
        authDomain: "joelcheonghsdata.firebaseapp.com",
        databaseURL: "https://joelcheonghsdata-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "joelcheonghsdata",
        storageBucket: "joelcheonghsdata.appspot.com",
        messagingSenderId: "246172949748",
        appId: "1:246172949748:web:b6de0a64bba1f7f49892a1"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const database = getDatabase(app);

    //IMPORTANTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT
    //LOGIN AGAIN WHEN PAGE SWITCH

    //Retrieve input
    var account = localStorage.getItem("account");
    var pass = localStorage.getItem("pass");

    //Sign In function
    signInWithEmailAndPassword(auth, account, pass)
        .then((userCredential) => {
            // Signed in 
            const user = userCredential.user;

            var lgDate = new Date();
            update(ref(database, 'users/' + user.uid), {
            })
                .then(() => {
                    // Switch page login
                    console.log(user.uid + ' is currently logged in.');
                })
                .catch((error) => {
                    // The write failed...
                    console.log(error);
                });
        })
        .catch((error) => {
            const errorCode = error.code;
            const errorMessage = error.message;
            console.log(errorCode + ' Bug. ' + errorMessage);
            //Direct to login if login is outdated. (not staff code)
            window.location.href = "login.html";
        });

    //Auto refresh staff status
    var currentdate = new Date();
    var date = currentdate.getFullYear() + "/"
        + (currentdate.getMonth() + 1) + "/"
        + currentdate.getDate();

    onValue(ref(database, 'staffcode/' + sessionStorage.getItem('staffCode') + '/attendance/' + date), (snapshot) => {
        if (snapshot.exists()) {
            //Find unfinish clock-in - Active
            var end = false;
            snapshot.forEach(function (childSnapshot) {
                if (childSnapshot.child("end").val() == false) {
                    end = true;
                    document.getElementById("accStatus").className = "stActive detail";
                }
            });
            //If no unfinish clock-in - Unactive
            if (end == false) {
                document.getElementById("accStatus").className = "stUnactive detail";
            }
        }
    });

</script>

</html>